

## we are trying to put down a simple view of the node, it's data
## and the data around the node.
## if the user clicks on a related node we shift to focusing
## on that node

## to keep it simple for now we are going to put
## a box in the middle of the page which is the focus'd
## the related nodes around it

## we are going to setup templates for each of the node types
## each of the templates is going to be rendered into a cell
## who's size is unknown

<html>
<head>

    <script src="https://ajax.googleapis.com/ajax/libs/ext-core/3.1.0/ext-core-debug.js"></script>

    <script>

    // for some reason when i wrote this javascript I was
    // in a competition with myself to not comment any of
    // it. I have no explaination other than it was
    // quote late

    // workers to build up the functions
    // which will act as renderers
    var node_renderers = {};

    node_renderers['DEFAULT'] = function(d) {
        return '';
    };

    var render = function(data) {
        // find our renderer
        var r = node_renderers[data['type']];
        if(Ext.isEmpty(r))
            r = node_renderers['DEFAULT'];
        return r(data);
    }

    var T = function(type,renderers) {
        node_renderers[type] = function(data) {
            var pieces = [];
            for(var k in data) {  
                var result = data[k];
                var r;
                Ext.each(renderers,function(renderer) {
                    // we are assuming/enforcing only one renderer hit
                    r = renderer(k,data[k]);
                    if(!Ext.isEmpty(r) && r) {
                        pieces.push(r);
                        return false;
                    }
                },this);
            }
            var p, to_return = '';
            while(p = pieces.pop()) {
                to_return += ''+p+'<br/>';
            }
            return to_return;
        };
    };

    var get_renderer = function(name,modifiers) {
        return (function(k,v) {
            if(name==k) {
                Ext.each(modifiers,function(m) {
                    v = m(v);
                },this);
                return v;
            }
            return false;
        });
    };

    var F = function() {
        arguments = Array.prototype.slice.call(arguments);
        var name = arguments[0];
        var modifiers = arguments.splice(1);
        return get_renderer(name,modifiers);
    };

    // possible modifiers
    var as_link = function(v) {
        return '<a href="'+v+'">'+v+'</a>';
    };
    var bold = function(v) {
        return '<b>'+v+'</b>';
    };
    var image = function(size) {
        return (function(v) {
            var r = '<img src="'+v+'" ';
            switch(size) {
                case 'small':
                    r += 'width="50px"';
                    break;
                default:
                    r += 'width="100"';
            }
            r += '/>';
            return r;
        })
    };

    // our data
    T('FeedEntry',[
        F('source',as_link),
        F('title',bold),
        F('body'),
        F('timestamp') 
    ]);

    T('Comment',[
        F('title',bold),
        F('comment')
    ]);

    T('User',[
        F('handle',bold),
        F('avatar_url',image('small'))
    ]);

    T('Author',[
        F('handle',bold),
        F('avatar_url',image('small'))
    ]);


    // the main elements on the page we touch
    var MAIN_EL = function() {
        return Ext.get('main_el');
    };

    var RELATIVE_CONTAINER = function(el) {
        var rel;
        el = Ext.get(el);
        if(!Ext.isEmpty(el)) {
            if(el != MAIN_EL()) {
                rel = el.down('.relative_container');
                if(!Ext.isEmpty(rel))
                    return rel
                rel = Ext.DomHelper.append(el,{
                    tag:'div',
                    cls:'relative_container'
                },true);
            }
            if(!Ext.isEmpty(rel))
                return rel
        }
        return Ext.get('relative_container');
    }

    // adds a focus clickable to each node
    var append_focus_button = function(el,data) {
        var b = Ext.DomHelper.append(el,{ tag:'a', 
                                          href:'#',
                                          html:'focus',
                                          cls:'focus'},
                                     true);
        b.on('click',function() { activate(data.id); });
    };


    // appends a link to add a comment node
    var append_comment_button = function(el,data) {
        var b = Ext.DomHelper.append(el,{ tag:'a',
                                          href:'#',
                                          html:'comment',
                                          cls:'comment' },
                                     true);
    };

    // update a node
    var update_node = function(el,data) {
        el.update(render(data));
        if(el != MAIN_EL()) {
            append_focus_button(el,data);
        }

    };


    // clear out the relative nodes
    var clear_relatives = function() {
        RELATIVE_CONTAINER().select('.relative_node').each(function(el) {
            el.remove();
        },this);
    }

    var relative_filter_items = [];
    var possible_filters = [];

    var _handle_filter_button = function() {
        if(relative_filter_items.indexOf(this.type) != -1) {
            relative_filter_items.remove(this.type);
            this.removeClass('enabled');
        } else {
            relative_filter_items.push(this.type);
            this.addClass('enabled');
        }
        activate(last_data.id);
    };

    var update_filter_buttons = function() {
        var container = Ext.get('filter_button_container');
        container.select('button').each(function(b) {
            b.remove();
        },this);
        Ext.each(possible_filters,function(type) {
            var b = Ext.DomHelper.append(container,
                                         '<button>'+type+'</button>',
                                         true);

            b.type = type;
            if(relative_filter_items.indexOf(b.type) != -1)
                b.addClass('enabled');
            b.on('click',_handle_filter_button);
        },this);
    };

    var update_possible_filters = function(relatives) {
        Ext.each(relatives,function(r) {
            if(possible_filters.indexOf(r.type) == -1)
                possible_filters.push(r.type);
        },this);
        update_filter_buttons();
    };

    // filter relative nodes if a relative filter is set
    var filter_relatives = function(relatives) {
        update_possible_filters(relatives);
        if(!Ext.isEmpty(relative_filter_items)) {
            var _to_remove = [];
            Ext.each(relatives,function(rel) {
                if(relative_filter_items.indexOf(rel.type)==-1)
                    _to_remove.push(rel);
            },this);
            Ext.each(_to_remove,function(tr) {
                relatives.remove(tr);
            },this);
        }
        return relatives;
    };

    var _get_relatives = function(rels) {
        if(!Ext.isEmpty(rels))
            return filter_relatives(rels);
        return [];
    };

    var get_relatives = function(data) {
        return _get_relatives(data._relatives);
    };

    // add relative nodes
    var add_relative = function(data,node_el) {
        var el = Ext.DomHelper.append(RELATIVE_CONTAINER(node_el),{
            tag: 'div',
            cls: 'relative_node'
        },true);
        update_node(el,data);
        var relatives = get_relatives(data);
        Ext.each(data._relatives,function(rel_data) {
            add_relative(rel_data,el);
        },this);
    };

    var last_data = {};
    var last_ids = [];

    var back = function() {
        activate(last_ids.pop());
    };

    var _handle_activate_response = function(data) {
        last_ids.push(last_data.id);
        last_data = data;

        console.log({data:data,last_data:last_data});

        // the root of data is going to be the node's data
        // use that data to update our main node div
        update_node(MAIN_EL(),data);

        // now update the relatives
        // first clear out the relatives we have showing now
        clear_relatives();

        // now that we have a clean canvas, render in
        // our relatives
        var relatives = get_relatives(data);
        Ext.each(data._relatives,add_relative);
    };

    var handle_activate_response = function(response) {
        var data = Ext.decode(response.responseText);
        _handle_activate_response(data);
    };

    var handle_activate_multi_response = function(response) {
        var data = Ext.decode(response.responseText);
        data = {_relatives:data};
        _handle_activate_response(data);
    }

    var load_front_page = function(count) {
        var front_page_count = count || 10;
        Ext.Ajax.request({
            url:'/node/recent/'+front_page_count,
            success: handle_activate_multi_response
        });
    }

    // function to update our view
    var activate = function(id) {
        console.log('activating '+id)
        if(Ext.isEmpty(id)) {
            load_front_page();
            return;
        }

        // fetch the nodes data
        var depth = 2;
        Ext.Ajax.request({
            url:'/node/get/'+id+'/'+depth+'/',
            success: handle_activate_response
        });
    };

    // function which will return back the fields
    // a node has
    var get_node_fields = function(node_type,callback,scope) {
        Ext.Ajax.request({
            scope:this,
            url:'/node/describe/'+node_type,
            success: function(response) {
                data = Ext.decode(response.responseText);
                callback.apply(scope,[data]);
            }
        });
    };

    // submit a node update / create
    var submit_node_update = function(form) {
        // if there is an id in the form than
        // it's an update not new
        var type = form.child('input[name=id]')?'update':'create';
        console.log({form:form,type:type});
        Ext.Ajax.request({
            scope:this,
            form:form,
            url:'/node/'+type,
            success: function(response) {
                // data is the node's new data
                var data = Ext.decode(response.responseText);

                // now that we have submitted we
                // can clear the form
                form.remove();
            }
        });
    };

    // show's the edit / new obj form on the page
    var FIELD_TEMPLATE = {
        'str': new Ext.Template('<input type="text"',
                                'name="{name}"',
                                'value="{value}"'),
        'hidden': new Ext.Template('<input type="hidden"',
                                   'name="{name}"',
                                   'value="{value}"')
    };

    var show_node_edit = function(node_type,fields,data) {
        // get the container
        var container = Ext.get('form_container');

        console.log({'node_type':node_type,'fields':fields,'data':data});

        // create our form
        var name, type, form_html = [];
        for(name in fields) {
            type = fields[name];
            console.log({'type':type,'name':name});
            form_html.push(FIELD_TEMPLATE[type].apply({'name':name,
                                                       'value':data[name]}));
        }

        // if we were passed an id render that in also
        if(!Ext.isEmpty(data['id'])) {
            form_html.push(FIELD_TEMPLATE['hidden'].apply({'name':'id',
                                                          'value':data['id']}));
        }

        // add in the nodes type
        form_html.push(FIELD_TEMPLATE['hidden'].apply({'name':'type',
                                                       'value':node_type}));

        // render in our form
        var form = Ext.DomHelper.append(container,{
            tag:'form',
            html:form_html.join('\n')
        },true);

        // add in the submit button
        var button = Ext.DomHelper.append(form,{
            tag:'button',
            html:'Submit'
        },true);

        // add in our click handler for the button
        button.on('click',function(e) {
            // stop default button action (aka submit)
            e.preventDefault();

            // submit the form
            submit_node_update(form);
        },this);
    };
    
    // we want to be able to add a new comment
    // to an existing node
    var add_comment = function(relative_id) {
        // first get the fields that a comment
        // can have
        get_node_fields('Comment',function(fields) {
            // now that we know the fields,
            // put up a form w/ those fields
            show_node_edit('Comment',fields,{});
        },this);
    };


    // disable AJAX requests adding a random
    // arg for caching
    Ext.onReady(function() { Ext.Ajax.disableCaching = false; });
    Ext.onReady(load_front_page);
    </script>


    <style>
        body { padding: 0; margin: 0; }
        #main_el {
            padding: 15px;
        }
        #relative_container {
            margin: 5px 10px 10px 20px;;
        }
        .relative_node {
            border: 4px solid #cccccc;
            padding: 10px;
            margin: 0 0 10px 0;
            position: relative;
        }
        button {
            border: 1px solid #cccccc;
            margin: 0 2px;
        }
        button.enabled {
            border: 1px solid black;
        }
        .focus {
            position: absolute;
            top: 5px;
            right: 5px;
        }
        #navigation_container {
            padding: 0;
            margin: 0 0 0 0;
        }
    </style>
</head>


<body>
    <div id="form_container">
    </div>
    <div id="navigation_container">
        <button onClick="back(); return false;">BACK</button>
    </div>
    <div id="main_el">
    </div>
    <hr/>
    <div id="node_action_container">
    </div>
    <hr/>
    <div id="filter_button_container">
    </div>
    <hr/>
    <div id="relative_container">
    </div>
</body>
</html>
